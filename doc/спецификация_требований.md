# Спецификация требований

## 1. Общее описание

### 1.1. Цель создания

Разработать кроссплатформенную информационную систему для создания туристических маршрутов с привязкой фотографий к точкам на интерактивной карте и возможностью совместного использования на основе микросервисной архитектуры.

### 1.2. Границы проекта

**Что входит в проект:**
- Веб-приложение (PWA) для создания, редактирования и просмотра маршрутов с фотографиями на интерактивной карте
- Десктоп-приложение (Tauri) с аналогичным функционалом
- Система аутентификации и авторизации с ролевой моделью (администратор, модератор, пользователь)
- Серверная обработка фотографий: компрессия, создание миниатюр, загрузка в объектное хранилище
- Импорт маршрутов из GeoJSON, экспорт в GPX и KML
- Социальные функции: комментарии, лайки, рейтинги, уведомления
- Шаринг маршрутов по ссылке с интерактивной картой
- Каталог маршрутов с категориями, поиском и фильтрацией
- Система закладок (избранные маршруты)
- Административная панель: управление пользователями, модерация контента, статистика
- CI/CD pipeline, контейнеризация (Docker), оркестрация (Kubernetes)
- Мониторинг и логирование (OpenTelemetry, Prometheus)

**Что не входит в разработку:**
- Нативные мобильные приложения (iOS/Android) — за пределами текущей итерации
- Система онлайн-оплаты и монетизации
- Интеграция с GPS-устройствами (Garmin, Suunto и др.)
- Модуль бронирования экскурсий
- Чат между пользователями

### 1.3. Окружение системы

Продукт является самостоятельной информационной системой, состоящей из следующих компонентов:
- **Frontend** — React SPA, развёрнутый за nginx reverse proxy
- **Backend** — 5 микросервисов (auth, routes, photo-worker, cache, tiles)
- **База данных** — PostgreSQL 16 (auth_db, routes_db)
- **Кэш** — Redis 7
- **Брокер сообщений** — NATS с JetStream
- **Объектное хранилище** — MinIO (S3-совместимый)

Взаимодействие с внешними системами:
- OpenStreetMap — источник картографических тайлов
- Open-Meteo API — данные о высоте рельефа
- Nominatim — геокодирование (поиск по адресу)

### 1.4. Характеристики пользователей

| Роль | Описание | Ключевые действия |
|---|---|---|
| **Пользователь** | Зарегистрированный пользователь системы. Может создавать маршруты, загружать фотографии, делиться маршрутами. | Создание/редактирование/удаление маршрутов; загрузка фото; комментирование; лайки; рейтинги; закладки; импорт/экспорт; просмотр каталога |
| **Модератор** | Пользователь с расширенными правами модерации контента. | Всё, что может пользователь + удаление чужих комментариев; скрытие маршрутов, нарушающих правила; просмотр лога модерации |
| **Администратор** | Пользователь с полным доступом к системе. | Всё, что может модератор + управление пользователями; назначение ролей; управление категориями; просмотр системной статистики; удаление любых маршрутов |

Неавторизованный пользователь может просматривать shared-маршруты по ссылке, видеть комментарии, лайки и рейтинги, но не может создавать контент.

### 1.5. Предположения и зависимости

**Предположения:**
- Пользователи загружают фотографии в формате JPEG/PNG, не превышающие 20 МБ.
- Фотографии могут содержать EXIF-данные с GPS-координатами для автоматического определения местоположения.
- У пользователей есть стабильное интернет-соединение для загрузки фотографий (оффлайн-режим поддерживает только просмотр ранее загруженных маршрутов).

**Зависимости:**
- Система зависит от доступности OpenStreetMap tile-серверов для отображения карты.
- Расчёт набора высоты зависит от Open-Meteo Elevation API.
- Автоматическая маршрутизация (режим «авто») зависит от OSRM (через Leaflet Routing Machine).

### 1.6. Термины и соглашения

| Термин | Определение |
|---|---|
| **Маршрут** | Набор точек на карте с координатами, опционально связанных линиями (автоматическая или ручная маршрутизация), с привязанными фотографиями |
| **Точка маршрута** | Географическая координата (широта, долгота) на карте с опциональной привязанной фотографией |
| **Фототочка** | Точка маршрута, к которой привязана фотография, отображаемая в попапе при нажатии на маркер |
| **Шаринг** | Предоставление доступа к маршруту по уникальной ссылке (токену) без необходимости авторизации |
| **Сегмент** | Участок маршрута между двумя соседними точками, может быть автоматическим (по дорогам) или ручным (прямая линия) |
| **PWA** | Progressive Web App — веб-приложение с возможностью установки на устройство и работы оффлайн |
| **JWT** | JSON Web Token — формат токенов аутентификации |
| **NATS JetStream** | Система обмена сообщениями для асинхронной обработки задач (фотографий) |
| **MinIO** | S3-совместимое объектное хранилище для фотографий |

---

## 2. Детальные требования

### 2.1. Требования к внешним интерфейсам

#### 2.1.1. Интерфейсы пользователя (UI)

- Веб-интерфейс реализован как SPA (Single Page Application) на React 19.
- Интерактивная карта на базе Leaflet с поддержкой нескольких провайдеров тайлов (OpenStreetMap, Yandex, 2GIS, OpenTopoMap).
- Адаптивный дизайн для экранов от 320px (мобильные) до 2560px (десктоп).
- Поддержка русского и английского языков (i18n).
- PWA: установка на домашний экран, работа оффлайн для просмотра закэшированных маршрутов.
- Десктоп-приложение (Tauri): нативное окно, системный трей, нативный выбор файлов.

#### 2.1.2. Аппаратные интерфейсы

- Работа с GPS-модулем устройства (через Geolocation API браузера) для определения текущего местоположения пользователя.
- Чтение EXIF-метаданных из фотографий для автоматического определения GPS-координат снимка.

#### 2.1.3. Программные интерфейсы

- **OpenStreetMap Tile API** — получение картографических тайлов (формат PNG, протокол HTTP).
- **Open-Meteo Elevation API** — получение данных о высоте по координатам (формат JSON, REST API).
- **Nominatim API** — геокодирование: поиск координат по адресу (формат JSON, REST API).
- **OSRM** — построение маршрута между точками по дорожной сети (через Leaflet Routing Machine).

#### 2.1.4. Интерфейсы связи и коммуникации

- HTTP/HTTPS (REST API) — взаимодействие frontend ↔ backend.
- WebSocket — real-time уведомления об обработке фотографий.
- NATS (TCP) — асинхронная обработка задач внутри backend.
- S3 API (HTTP) — загрузка/получение фотографий из MinIO.

---

### 2.2. Функциональные требования

#### Модуль аутентификации

**FR-01: Регистрация пользователя**
- Описание: Система должна позволять новому пользователю зарегистрироваться.
- Входные данные: Email, пароль.
- Условия: Email уникальный; пароль не менее 8 символов.
- Результат: Создание учётной записи с ролью «пользователь»; выдача JWT-токенов (access + refresh).
- Приоритет: Высокий

**FR-02: Аутентификация**
- Описание: Пользователь входит в систему по email и паролю.
- Результат: Выдача пары JWT-токенов (access 15 мин, refresh 7 дней).
- Приоритет: Высокий

**FR-03: Обновление токена**
- Описание: Система обновляет access-токен по валидному refresh-токену.
- Приоритет: Высокий

**FR-04: Просмотр и редактирование профиля**
- Описание: Пользователь может просматривать и редактировать имя и аватар.
- Приоритет: Средний

**FR-05: Смена пароля**
- Описание: Пользователь может сменить пароль, указав текущий и новый.
- Условия: Текущий пароль корректен; новый пароль >= 8 символов.
- Приоритет: Средний

#### Модуль маршрутов

**FR-06: Создание маршрута**
- Описание: Пользователь создаёт маршрут, размещая точки на интерактивной карте кликом.
- Входные данные: Название маршрута, набор точек (координаты).
- Результат: Маршрут сохраняется в БД с JSONB-массивом точек.
- Приоритет: Высокий

**FR-07: Редактирование маршрута**
- Описание: Пользователь может изменить название, добавить/удалить/переместить точки, изменить режим сегментов (авто/ручной).
- Условия: Только владелец маршрута.
- Приоритет: Высокий

**FR-08: Удаление маршрута**
- Описание: Пользователь удаляет свой маршрут.
- Условия: Владелец или администратор.
- Приоритет: Высокий

**FR-09: Просмотр списка маршрутов**
- Описание: Пользователь видит список своих маршрутов с названием, датой, количеством точек.
- Приоритет: Высокий

**FR-10: Импорт маршрута из GeoJSON**
- Описание: Загрузка .geojson файла с парсингом LineString/MultiPoint в набор точек.
- Приоритет: Средний

**FR-11: Экспорт маршрута**
- Описание: Скачивание маршрута в формате GPX или KML.
- Приоритет: Средний

**FR-12: Шаринг маршрута**
- Описание: Генерация уникальной ссылки (UUID-токен) для доступа к маршруту без авторизации.
- Результат: Любой пользователь по ссылке видит интерактивную карту с маршрутом и фото-попапами.
- Приоритет: Высокий

#### Модуль фотографий

**FR-13: Загрузка фотографии к точке маршрута**
- Описание: Пользователь привязывает фотографию к конкретной точке маршрута.
- Входные данные: Файл изображения (JPEG/PNG, до 20 МБ).
- Результат: Фотография в формате base64 сохраняется в точке маршрута. Статус: «pending».
- Приоритет: Высокий

**FR-14: Асинхронная обработка фотографий**
- Описание: После сохранения маршрута photo-worker извлекает base64-фотографии, сжимает (макс. 1920px, 85% JPEG quality), создаёт миниатюры (300px), загружает в MinIO S3, обновляет URL в БД.
- Результат: Статус фото меняется на «done», URL обновлены.
- Приоритет: Высокий

**FR-15: Real-time уведомления об обработке фото**
- Описание: Frontend получает WebSocket-уведомление о завершении обработки фотографии и обновляет отображение без перезагрузки страницы.
- Приоритет: Средний

#### Модуль социальных функций

**FR-16: Комментарии к маршруту**
- Описание: Авторизованный пользователь может добавить текстовый комментарий к маршруту. Удалить может автор комментария или модератор.
- Приоритет: Средний

**FR-17: Лайки**
- Описание: Авторизованный пользователь может поставить/убрать лайк маршруту (один лайк на пользователя).
- Результат: Отображается общее количество лайков.
- Приоритет: Средний

**FR-18: Рейтинги**
- Описание: Авторизованный пользователь может поставить оценку маршруту от 1 до 5.
- Результат: Отображается средний рейтинг и количество оценок.
- Приоритет: Средний

**FR-19: Уведомления**
- Описание: Пользователь получает уведомления о новых комментариях, лайках и рейтингах к своим маршрутам.
- Результат: Список уведомлений с пометкой прочитано/непрочитано.
- Приоритет: Средний

**FR-20: Закладки (избранное)**
- Описание: Авторизованный пользователь может добавить чужой маршрут в закладки для быстрого доступа.
- Приоритет: Низкий

#### Модуль категорий и поиска

**FR-21: Категории маршрутов**
- Описание: Маршрут может быть отнесён к одной или нескольким категориям (пеший поход, велопрогулка, лыжный маршрут, экскурсия, бег).
- Приоритет: Средний

**FR-22: Каталог маршрутов (Explore)**
- Описание: Публичная страница с отображением всех shared-маршрутов. Фильтрация по категории, сортировка по рейтингу, дате, количеству лайков.
- Приоритет: Средний

**FR-23: Поиск маршрутов**
- Описание: Текстовый поиск по названию маршрута.
- Приоритет: Низкий

#### Модуль администрирования

**FR-24: Управление пользователями**
- Описание: Администратор может просматривать список пользователей, назначать и снимать роли.
- Условия: Только администратор.
- Приоритет: Высокий

**FR-25: Модерация маршрутов**
- Описание: Модератор/администратор может удалить любой маршрут, нарушающий правила.
- Приоритет: Средний

**FR-26: Модерация комментариев**
- Описание: Модератор/администратор может удалить любой комментарий.
- Приоритет: Средний

**FR-27: Управление категориями**
- Описание: Администратор может создавать, редактировать и удалять категории маршрутов.
- Приоритет: Средний

**FR-28: Системная статистика**
- Описание: Администратор видит дашборд: количество пользователей, маршрутов, комментариев, лайков; активность по дням.
- Приоритет: Низкий

---

### 2.3. Нефункциональные требования

**NFR-01: Производительность**
- Время отклика API — менее 500 мс (95-й перцентиль) при 100 одновременных пользователях.
- Время обработки одной фотографии — менее 10 секунд.

**NFR-02: Безопасность**
- JWT-аутентификация с access-токенами (15 мин) и refresh-токенами (7 дней).
- Хеширование паролей алгоритмом Argon2.
- Защита от SQL injection (параметризованные запросы через SQLx).
- Защита от XSS (экранирование пользовательского ввода).
- HTTPS для всех соединений в production.

**NFR-03: Надёжность**
- Доступность системы не менее 99% времени.
- Повторная обработка фотографий при сбое (NATS JetStream, max 3 попытки).
- Автоматический reconnect WebSocket при обрыве соединения.

**NFR-04: Масштабируемость**
- Горизонтальное масштабирование через Kubernetes (каждый микросервис масштабируется независимо).
- Кэширование тайлов карт в Redis для снижения нагрузки на внешние API.

**NFR-05: Локализация**
- Поддержка русского и английского языков интерфейса.
- Переключение языка без перезагрузки страницы.

**NFR-06: Кроссплатформенность**
- Веб-приложение (PWA): Chrome, Firefox, Safari, Edge — последние 2 версии.
- Десктоп-приложение (Tauri): Linux, Windows.
- PWA: установка на Android/iOS через браузер.

---

## 3. Приложения

### A. Макеты пользовательского интерфейса

Макеты основных экранов будут представлены в приложении к пояснительной записке ВКР.

Основные экранные формы (20):
1. Страница входа (Login)
2. Страница регистрации (Register)
3. Главная карта — создание маршрута (MapPage create)
4. Главная карта — редактирование маршрута (MapPage edit)
5. Профиль пользователя (ProfilePage)
6. Просмотр shared-маршрута (SharedMapPage)
7. Каталог маршрутов (ExplorePage)
8. Закладки (BookmarksPage)
9. Уведомления (NotificationsPage)
10. Настройки (SettingsPage)
11. О проекте (AboutPage)
12. Помощь (HelpPage)
13. Страница 404 (NotFoundPage)
14. Админ: дашборд (AdminDashboard)
15. Админ: пользователи (AdminUsersPage)
16. Админ: маршруты (AdminRoutesPage)
17. Админ: комментарии (AdminCommentsPage)
18. Админ: категории (AdminCategoriesPage)
19. Попап фотографии на карте
20. Панель статистики маршрута (RouteStatsPanel)

### B. Модели данных

**Таблицы БД (12):**

| # | Таблица | БД | Описание |
|---|---|---|---|
| 1 | users | auth_db | Пользователи (email, password_hash, name, avatar_url) |
| 2 | routes | routes_db | Маршруты (user_id, name, points JSONB, share_token) |
| 3 | comments | routes_db | Комментарии к маршрутам |
| 4 | route_likes | routes_db | Лайки (unique user+route) |
| 5 | route_ratings | routes_db | Рейтинги 1-5 (unique user+route) |
| 6 | roles | routes_db | Роли (admin, moderator, user) |
| 7 | user_roles | routes_db | Связь пользователь-роль (M:N) |
| 8 | categories | routes_db | Категории маршрутов |
| 9 | route_categories | routes_db | Связь маршрут-категория (M:N) |
| 10 | notifications | routes_db | Уведомления пользователей |
| 11 | route_bookmarks | routes_db | Закладки (избранные маршруты) |
| 12 | route_views | routes_db | Просмотры маршрутов |

### C. Дополнительная информация

**Микросервисы (5):**

| Сервис | Язык | Фреймворк | Назначение |
|---|---|---|---|
| auth | Rust | Axum | Аутентификация, профили, JWT |
| routes | Rust | Axum | Маршруты, комментарии, лайки, рейтинги, роли, категории, уведомления, WebSocket |
| photo-worker | Rust | — | Асинхронная обработка фотографий (NATS consumer) |
| cache | Go | Gin | Кэширование тайлов карт (Redis) |
| tiles | Go | Gin | Проксирование тайлов OpenStreetMap |
